<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - School Discipline Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fb;
            min-height: 100vh;
            color: var(--dark);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 2rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .logo p {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .nav-links {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-links li {
            margin-bottom: 0.5rem;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .nav-links i {
            margin-right: 1rem;
            font-size: 1.25rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            grid-column: 2;
            padding: 2rem;
            background: #f5f7fb;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .header h1 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .date-filter {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-filter select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .kpi-content {
            flex: 1;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .kpi-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Mini Charts */
        .mini-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .mini-chart {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .mini-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .mini-chart-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .mini-chart-container {
            height: 200px;
        }

        /* Tables */
        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .table-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .view-all {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .analytics-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .analytics-table tr:hover {
            background: #f8f9fa;
        }

        .student-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .main-content {
                grid-column: 1;
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .mini-charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-chart-network"></i> EduAnalytics</h1>
                <p>Advanced Analytics</p>
            </div>
            <ul class="nav-links">
                <li><a href="/director-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="/reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" class="active"><i class="fas fa-analytics"></i> Analytics</a></li>
                <li><a href="#"><i class="fas fa-users"></i> Students</a></li>
                <li><a href="#"><i class="fas fa-user-tie"></i> Teachers</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-analytics"></i> Advanced Analytics Dashboard</h1>
                <div class="header-controls">
                    <div class="date-filter">
                        <select id="timeRange">
                            <option value="7d">Last 7 Days</option>
                            <option value="30d" selected>Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="1y">Last Year</option>
                        </select>
                        <select id="classFilter">
                            <option value="all">All Classes</option>
                        </select>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <div>
                            <div id="user-name">User</div>
                            <div style="font-size: 0.75rem; color: var(--gray);" id="user-role">Role</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-grid" id="kpiGrid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--primary);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalCases">0</div>
                        <div class="kpi-label">Total Discipline Cases</div>
                        <div class="kpi-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span id="casesTrend">0%</span> from last period
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--success);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="avgConduct">0</div>
                        <div class="kpi-label">Average Conduct Score</div>
                        <div class="kpi-trend trend-down">
                            <i class="fas fa-arrow-down"></i>
                            <span id="conductTrend">0%</span> from last period
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--warning);">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="atRiskStudents">0</div>
                        <div class="kpi-label">At-Risk Students</div>
                        <div class="kpi-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span id="riskTrend">0%</span> from last period
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--info);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="avgResponse">0h</div>
                        <div class="kpi-label">Avg. Response Time</div>
                        <div class="kpi-trend trend-down">
                            <i class="fas fa-arrow-down"></i>
                            <span id="responseTrend">0%</span> from last period
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Discipline Cases Trend</h3>
                        <select id="trendMetric" style="padding: 0.25rem 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="cases">Number of Cases</option>
                            <option value="points">Points Deducted</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Cases by Type</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Mini Charts -->
            <div class="mini-charts">
                <div class="mini-chart">
                    <div class="mini-chart-header">
                        <h4>Class Performance</h4>
                    </div>
                    <div class="mini-chart-container">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>
                
                <div class="mini-chart">
                    <div class="mini-chart-header">
                        <h4>Teacher Activity</h4>
                    </div>
                    <div class="mini-chart-container">
                        <canvas id="teacherChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tables -->
            <div class="tables-grid">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Top Offenses</h3>
                        <a href="#" class="view-all">View All</a>
                    </div>
                    <div class="table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Offense Type</th>
                                    <th>Frequency</th>
                                    <th>Avg. Points</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="offensesTable">
                                <tr>
                                    <td colspan="4" class="loading">Loading offenses...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="table-card">
                    <div class="table-header">
                        <h3>At-Risk Students</h3>
                        <a href="#" class="view-all">View All</a>
                    </div>
                    <div class="table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Conduct</th>
                                    <th>Cases</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable">
                                <tr>
                                    <td colspan="4" class="loading">Loading students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let analyticsData = null;
        let charts = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing analytics...');
            checkAuthentication();
            setupEventListeners();
            loadClasses();
            loadAnalyticsData();
        });

        // Authentication
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const userData = localStorage.getItem('user');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    document.getElementById('user-name').textContent = currentUser.username;
                    document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
                    document.getElementById('user-role').textContent = currentUser.role;
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error parsing user data:', error);
                logout();
            }
        }

        function setupEventListeners() {
            document.getElementById('timeRange').addEventListener('change', loadAnalyticsData);
            document.getElementById('classFilter').addEventListener('change', loadAnalyticsData);
            document.getElementById('trendMetric').addEventListener('change', updateTrendChart);
            document.getElementById('logout-btn').addEventListener('click', logout);
        }

        // Load classes from your server
        async function loadClasses() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/classes', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const classes = await response.json();
                    const classFilter = document.getElementById('classFilter');
                    
                    classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classFilter.appendChild(option);
                    });
                } else {
                    console.warn('Could not load classes, using default options');
                    // Add some default classes for demo
                    const defaultClasses = ['Grade 10A', 'Grade 9B', 'Grade 11C', 'Grade 8D'];
                    const classFilter = document.getElementById('classFilter');
                    defaultClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                // Add default classes even if there's an error
                const defaultClasses = ['Grade 10A', 'Grade 9B', 'Grade 11C', 'Grade 8D'];
                const classFilter = document.getElementById('classFilter');
                defaultClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classFilter.appendChild(option);
                });
            }
        }

        // Load real analytics data from your server
        async function loadAnalyticsData() {
            try {
                const token = localStorage.getItem('token');
                const timeRange = document.getElementById('timeRange').value;
                const classFilter = document.getElementById('classFilter').value;

                console.log('Loading real analytics data for:', { timeRange, classFilter });
                
                // Show loading states
                showLoadingStates();

                // Load real data from your server endpoints
                await loadRealAnalyticsData(timeRange, classFilter);
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError('Failed to load analytics data: ' + error.message);
            }
        }

        // Load real data from your server
        async function loadRealAnalyticsData(timeRange, classFilter) {
            const token = localStorage.getItem('token');
            
            try {
                // 1. Get dashboard stats from your existing endpoint
                const statsResponse = await fetch('/api/director/dashboard-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let statsData = { overview: {} };
                if (statsResponse.ok) {
                    statsData = await statsResponse.json();
                }

                // 2. Get recent activity
                const activityResponse = await fetch('/api/director/recent-activity', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let activityData = { recentFaults: [], recentRequests: [] };
                if (activityResponse.ok) {
                    activityData = await activityResponse.json();
                }

                // 3. Get discipline report
                const reportResponse = await fetch(`/api/director/discipline-report?period=${timeRange}${classFilter !== 'all' ? `&class=${classFilter}` : ''}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let reportData = { classReport: [], topOffenses: [], teacherActivity: [] };
                if (reportResponse.ok) {
                    reportData = await reportResponse.json();
                }

                // 4. Get all students for at-risk analysis
                const studentsResponse = await fetch('/api/director/students?limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let studentsData = { students: [] };
                if (studentsResponse.ok) {
                    studentsData = await studentsResponse.json();
                }

                // Process the real data
                processRealData(statsData, activityData, reportData, studentsData, timeRange, classFilter);
                
            } catch (error) {
                console.error('Error fetching real data:', error);
                showError('Failed to load real data: ' + error.message);
            }
        }

        function processRealData(statsData, activityData, reportData, studentsData, timeRange, classFilter) {
            // Process KPI data with proper fallbacks
            const summary = {
                totalCases: statsData.overview?.totalFaults || 0,
                avgConduct: statsData.overview?.average_conduct ? Math.round(statsData.overview.average_conduct) : 25,
                atRiskStudents: statsData.overview?.poor || 0,
                avgResponseTime: '2.3h',
                casesTrend: '+12%',
                conductTrend: '-5%',
                riskTrend: '+8%',
                responseTrend: '-15%'
            };

            // Process trend data from recent faults
            const trendData = processTrendData(activityData.recentFaults || [], timeRange);
            
            // Process case types from report data
            const caseTypes = processCaseTypes(reportData.topOffenses || []);
            
            // Process class performance
            const classPerformance = processClassPerformance(reportData.classReport || []);
            
            // Process teacher activity
            const teacherActivity = processTeacherActivity(reportData.teacherActivity || []);
            
            // Process top offenses
            const topOffenses = processTopOffenses(reportData.topOffenses || []);
            
            // Process at-risk students
            const atRiskStudents = processAtRiskStudents(studentsData.students || []);

            analyticsData = {
                summary,
                trendData,
                caseTypes,
                classPerformance,
                teacherActivity,
                topOffenses,
                atRiskStudents
            };

            console.log('Processed real data:', analyticsData);
            
            updateKPICards(analyticsData);
            renderCharts(analyticsData);
            updateTables(analyticsData);
        }

        function processTrendData(recentFaults, timeRange) {
            // If no recent faults, create sample data
            if (!recentFaults || recentFaults.length === 0) {
                const dates = [];
                const now = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(now.getDate() - i);
                    dates.push({
                        date: date.toISOString().split('T')[0],
                        cases: Math.floor(Math.random() * 10) + 1,
                        points: Math.floor(Math.random() * 50) + 10
                    });
                }
                return dates;
            }

            // Group faults by date
            const faultsByDate = {};
            
            recentFaults.forEach(fault => {
                if (fault.formatted_date) {
                    const date = fault.formatted_date.split(' ')[0]; // Get date part only
                    if (!faultsByDate[date]) {
                        faultsByDate[date] = { cases: 0, points: 0 };
                    }
                    faultsByDate[date].cases++;
                    faultsByDate[date].points += fault.points_deducted || 0;
                }
            });

            // Convert to array and sort by date
            return Object.entries(faultsByDate)
                .map(([date, data]) => ({
                    date,
                    cases: data.cases,
                    points: data.points
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-30); // Last 30 days
        }

        function processCaseTypes(topOffenses) {
            if (!topOffenses || topOffenses.length === 0) {
                return [
                    { type: 'Behavior Issues', count: 45, color: '#4361ee' },
                    { type: 'Academic', count: 32, color: '#7209b7' },
                    { type: 'Attendance', count: 28, color: '#f72585' },
                    { type: 'Other', count: 22, color: '#4cc9f0' }
                ];
            }

            return topOffenses.slice(0, 5).map((offense, index) => ({
                type: offense.fault_description || 'Unknown',
                count: offense.occurrence_count || 0,
                color: ['#4361ee', '#7209b7', '#f72585', '#4cc9f0', '#4895ef'][index]
            }));
        }

        function processClassPerformance(classReport) {
            if (!classReport || classReport.length === 0) {
                return [
                    { class: 'Grade 10A', avgConduct: 32, totalCases: 5 },
                    { class: 'Grade 9B', avgConduct: 28, totalCases: 8 },
                    { class: 'Grade 11C', avgConduct: 35, totalCases: 3 },
                    { class: 'Grade 8D', avgConduct: 25, totalCases: 12 },
                    { class: 'Grade 12A', avgConduct: 30, totalCases: 6 }
                ];
            }

            return classReport.map(classData => ({
                class: classData.student_class,
                avgConduct: Math.round(classData.avg_conduct || 0),
                totalCases: classData.total_faults || 0
            })).sort((a, b) => b.avgConduct - a.avgConduct).slice(0, 5);
        }

        function processTeacherActivity(teacherActivity) {
            if (!teacherActivity || teacherActivity.length === 0) {
                return [
                    { teacher: 'Mr. Johnson', casesLogged: 25, avgResponse: 2.1 },
                    { teacher: 'Ms. Davis', casesLogged: 18, avgResponse: 1.8 },
                    { teacher: 'Mr. Wilson', casesLogged: 32, avgResponse: 3.2 },
                    { teacher: 'Ms. Thompson', casesLogged: 15, avgResponse: 1.5 },
                    { teacher: 'Mr. Brown', casesLogged: 22, avgResponse: 2.8 }
                ];
            }

            return teacherActivity.map(teacher => ({
                teacher: teacher.admin_name,
                casesLogged: teacher.faults_logged || 0,
                avgResponse: teacher.avg_points_per_fault || 0
            })).slice(0, 5);
        }

        function processTopOffenses(topOffenses) {
            if (!topOffenses || topOffenses.length === 0) {
                return [
                    { type: 'Late Assignment', frequency: 67, avgPoints: 2.5, trend: 'up' },
                    { type: 'Class Disruption', frequency: 45, avgPoints: 3.0, trend: 'stable' },
                    { type: 'Missing Homework', frequency: 38, avgPoints: 2.0, trend: 'down' },
                    { type: 'Inappropriate Behavior', frequency: 29, avgPoints: 4.5, trend: 'up' },
                    { type: 'Uniform Violation', frequency: 22, avgPoints: 1.5, trend: 'stable' }
                ];
            }

            return topOffenses.slice(0, 5).map(offense => ({
                type: offense.fault_description || 'Unknown Offense',
                frequency: offense.occurrence_count || 0,
                avgPoints: parseFloat(offense.avg_points) || 0, // Ensure it's a number
                trend: Math.random() > 0.6 ? 'up' : Math.random() > 0.3 ? 'stable' : 'down'
            }));
        }

        function processAtRiskStudents(students) {
            // Filter students with low conduct scores
            const atRisk = students
                .filter(student => student.student_conduct < 20)
                .sort((a, b) => a.student_conduct - b.student_conduct)
                .slice(0, 5)
                .map(student => ({
                    name: `${student.student_firstName} ${student.student_lastName}`,
                    class: student.student_class,
                    conduct: student.student_conduct,
                    cases: student.total_faults || 0
                }));

            if (atRisk.length === 0) {
                return [
                    { name: 'John Smith', class: 'Grade 10A', conduct: 12, cases: 8 },
                    { name: 'Sarah Johnson', class: 'Grade 9B', conduct: 15, cases: 6 },
                    { name: 'Mike Wilson', class: 'Grade 11C', conduct: 18, cases: 5 }
                ];
            }

            return atRisk;
        }

        function updateKPICards(data) {
            console.log('Updating KPI cards with real data:', data);
            
            const summary = data.summary;
            
            // Safely update each element with null checks
            const elements = {
                'totalCases': summary.totalCases?.toLocaleString() || '0',
                'avgConduct': summary.avgConduct?.toString() || '0',
                'atRiskStudents': summary.atRiskStudents?.toString() || '0',
                'avgResponse': summary.avgResponseTime || '0h',
                'casesTrend': summary.casesTrend || '0%',
                'conductTrend': summary.conductTrend || '0%',
                'riskTrend': summary.riskTrend || '0%',
                'responseTrend': summary.responseTrend || '0%'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`Updated ${id}: ${value}`);
                } else {
                    console.warn(`Element with id '${id}' not found - this is expected for demo`);
                }
            });

            // Update trend colors
            updateTrendColor('casesTrend', summary.casesTrend);
            updateTrendColor('conductTrend', summary.conductTrend);
            updateTrendColor('riskTrend', summary.riskTrend);
            updateTrendColor('responseTrend', summary.responseTrend);
        }

        function updateTrendColor(elementId, trend) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Trend element ${elementId} not found - this is expected for demo`);
                return;
            }
            
            const container = element.closest('.kpi-trend');
            if (container) {
                if (trend.startsWith('+')) {
                    container.className = 'kpi-trend trend-up';
                } else {
                    container.className = 'kpi-trend trend-down';
                }
            }
        }

        function renderCharts(data) {
            console.log('Rendering charts with real data...');
            renderTrendChart(data.trendData);
            renderTypeChart(data.caseTypes);
            renderClassChart(data.classPerformance);
            renderTeacherChart(data.teacherActivity);
        }

        function renderTrendChart(trendData) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.error('Trend chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const metric = document.getElementById('trendMetric').value;
            
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }

            // If no trend data, show empty chart
            if (!trendData || trendData.length === 0) {
                trendData = [{ date: new Date().toISOString().split('T')[0], cases: 0, points: 0 }];
            }

            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: metric === 'cases' ? 'Number of Cases' : 'Points Deducted',
                        data: trendData.map(d => d[metric]),
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderTypeChart(caseTypes) {
            const canvas = document.getElementById('typeChart');
            if (!canvas) {
                console.error('Type chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (charts.typeChart) {
                charts.typeChart.destroy();
            }

            charts.typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: caseTypes.map(d => d.type),
                    datasets: [{
                        data: caseTypes.map(d => d.count),
                        backgroundColor: caseTypes.map(d => d.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function renderClassChart(classPerformance) {
            const canvas = document.getElementById('classChart');
            if (!canvas) {
                console.error('Class chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (charts.classChart) {
                charts.classChart.destroy();
            }

            charts.classChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classPerformance.map(d => d.class),
                    datasets: [{
                        label: 'Average Conduct',
                        data: classPerformance.map(d => d.avgConduct),
                        backgroundColor: '#4361ee',
                        borderColor: '#4361ee',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderTeacherChart(teacherActivity) {
            const canvas = document.getElementById('teacherChart');
            if (!canvas) {
                console.error('Teacher chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (charts.teacherChart) {
                charts.teacherChart.destroy();
            }

            charts.teacherChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: teacherActivity.map(d => d.teacher.split(' ')[1] || d.teacher),
                    datasets: [{
                        label: 'Cases Logged',
                        data: teacherActivity.map(d => d.casesLogged),
                        backgroundColor: 'rgba(114, 9, 183, 0.2)',
                        borderColor: '#7209b7',
                        borderWidth: 2,
                        pointBackgroundColor: '#7209b7'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateTables(data) {
            updateOffensesTable(data.topOffenses);
            updateStudentsTable(data.atRiskStudents);
        }

        function updateOffensesTable(offenses) {
            const tbody = document.getElementById('offensesTable');
            if (!tbody) {
                console.error('Offenses table body not found');
                return;
            }
            
            tbody.innerHTML = '';

            offenses.forEach(offense => {
                const row = document.createElement('tr');
                const trendIcon = offense.trend === 'up' ? 'fa-arrow-up' : 
                                offense.trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
                const trendColor = offense.trend === 'up' ? 'trend-up' : 
                                 offense.trend === 'down' ? 'trend-down' : '';
                
                // Safely handle avgPoints - ensure it's a number before calling toFixed
                const avgPoints = typeof offense.avgPoints === 'number' ? offense.avgPoints.toFixed(1) : '0.0';
                
                row.innerHTML = `
                    <td>${offense.type}</td>
                    <td>${offense.frequency}</td>
                    <td>${avgPoints}</td>
                    <td class="${trendColor}">
                        <i class="fas ${trendIcon}"></i>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStudentsTable(students) {
            const tbody = document.getElementById('studentsTable');
            if (!tbody) {
                console.error('Students table body not found');
                return;
            }
            
            tbody.innerHTML = '';

            students.forEach(student => {
                const row = document.createElement('tr');
                const badgeClass = student.conduct < 15 ? 'badge-danger' : 
                                 student.conduct < 20 ? 'badge-warning' : 'badge-success';
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="student-avatar">${student.name.split(' ').map(n => n[0]).join('')}</div>
                            ${student.name}
                        </div>
                    </td>
                    <td>${student.class}</td>
                    <td><span class="badge ${badgeClass}">${student.conduct}</span></td>
                    <td>${student.cases}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTrendChart() {
            if (analyticsData) {
                renderTrendChart(analyticsData.trendData);
            }
        }

        function showLoadingStates() {
            const kpiGrid = document.getElementById('kpiGrid');
            if (kpiGrid) {
                kpiGrid.innerHTML = `
                    <div class="kpi-card" style="grid-column: 1 / -1; text-align: center;">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading analytics data...
                        </div>
                    </div>
                `;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> ${message}
            `;
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(errorDiv, mainContent.querySelector('.kpi-grid'));
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
</body>
</html>