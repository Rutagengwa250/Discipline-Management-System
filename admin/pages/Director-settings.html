<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"%3E%3Ctext y="52" font-size="52"%3E%F0%9F%8E%93%3C/text%3E%3C/svg%3E'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mobile-logo h1 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .hamburger-menu {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Dashboard Container */
        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .logo {
            text-align: center;
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 2rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .logo p {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .nav-links {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-links li {
            margin-bottom: 0.5rem;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .nav-links i {
            margin-right: 1rem;
            font-size: 1.25rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            background: var(--light);
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .tab {
            flex: 1;
            padding: 1rem 1.5rem;
            text-align: center;
            background: none;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
            min-width: max-content;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings Sections */
        .settings-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 1.125rem;
        }

        .section-body {
            padding: 1.5rem;
        }

        /* Term Settings Styles */
        .term-status {
            display: flex;
            align-items: center;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge-primary { background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        .badge-danger { background: rgba(247, 37, 133, 0.1); color: var(--warning); }
        .badge-secondary { background: #e9ecef; color: var(--gray); }

        .term-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .current-term-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item label {
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }

        .form-text {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.terms { border-left-color: var(--primary); }
        .stat-card.students { border-left-color: var(--secondary); }
        .stat-card.promotion { border-left-color: var(--success); }
        .stat-card.backup { border-left-color: var(--info); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-card.terms .stat-icon { background: var(--primary); }
        .stat-card.students .stat-icon { background: var(--secondary); }
        .stat-card.promotion .stat-icon { background: var(--success); }
        .stat-card.backup .stat-icon { background: var(--info); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .action-card.warning {
            border-color: var(--warning);
        }

        .action-card.warning:hover {
            border-color: var(--warning);
        }

        .action-card.danger {
            border-color: #dc3545;
        }

        .action-card.danger:hover {
            border-color: #dc3545;
        }

        .action-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
            color: white;
        }

        .action-card.primary .action-icon { background: var(--primary); }
        .action-card.success .action-icon { background: var(--success); }
        .action-card.warning .action-icon { background: var(--warning); }
        .action-card.danger .action-icon { background: #dc3545; }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .action-card p {
            color: var(--gray);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3ab0d9;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #e11574;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover {
            background: #f8f9fa;
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Alert Boxes */
        .alert-box {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-warning {
            background: rgba(247, 37, 133, 0.1);
            border: 1px solid var(--warning);
        }

        .alert-info {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid var(--success);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid #dc3545;
        }

        .alert-icon {
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        .alert-warning .alert-icon { color: var(--warning); }
        .alert-info .alert-icon { color: var(--success); }
        .alert-danger .alert-icon { color: #dc3545; }

        .alert-content h4 {
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .alert-content p {
            color: var(--gray);
            margin: 0;
        }

        /* Backup Styles */
        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .backup-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .backup-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .backup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .backup-header h4 {
            margin: 0;
            color: var(--dark);
            font-size: 1.125rem;
        }

        .backup-type {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .backup-type.full {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .backup-type.students {
            background: rgba(114, 9, 183, 0.1);
            color: var(--secondary);
        }

        .backup-type.conduct {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .backup-meta, .backup-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .backup-meta div, .backup-stats div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .backup-description {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .backup-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray);
        }

        .error-message {
            background: rgba(247, 37, 133, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 1rem;
            color: var(--warning);
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* New styles for promotion system */
        .selected-count {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .students-checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            padding: 1rem;
        }

        .student-checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }

        .student-checkbox-item:hover {
            background-color: #f8f9fa;
        }

        .student-checkbox-item:last-child {
            border-bottom: none;
        }

        .student-checkbox-item input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.2);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #333;
        }

        .student-class {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .promotion-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card.repeat {
            border-left-color: #dc3545;
        }

        .summary-card.promote {
            border-left-color: #28a745;
        }

        .summary-card.graduate {
            border-left-color: #6f42c1;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Student Management Specific Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .table-header h4 {
            margin: 0;
            color: var(--dark);
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .conduct-score {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: #dc3545; }
        .text-muted {
            color: var(--gray) !important;
            font-size: 0.875rem;
        }

        .small {
            font-size: 0.875rem;
        }

        .text-center {
            text-align: center;
        }

        .student-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .bulk-select {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bulk-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Expulsion Modal */
        .expulsion-reasons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .reason-option {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .reason-option:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .reason-option.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        .reason-option input {
            display: none;
        }

        /* Auto Removal Section */
        .auto-removal-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .removal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .removal-stat-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .removal-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .removal-stat-label {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 98;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                transform: translateX(-100%);
                z-index: 99;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-header {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .settings-tabs {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
            
            .backup-grid {
                grid-template-columns: 1fr;
            }
            
            .bulk-actions {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-wrapper {
                overflow-x: auto;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .term-actions {
                flex-direction: column;
            }
            
            .term-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .backup-actions {
                flex-direction: column;
            }
            
            .backup-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .student-actions {
                flex-direction: column;
            }
            
            .student-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .expulsion-reasons {
                grid-template-columns: 1fr;
            }
            
            .promotion-summary-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .backup-meta, .backup-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .student-actions {
                flex-direction: column;
            }
            
            .header h2 {
                font-size: 1.5rem;
            }
            
            .tab {
                padding: 0.75rem 1rem;
            }
            
            .action-card {
                padding: 1.5rem;
            }
            
            .action-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .section-body {
                padding: 1rem;
            }
            
            .modal-content {
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-content">
            <div class="mobile-logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>DMS</h1>
            </div>
            <button class="hamburger-menu" id="hamburger-menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- Overlay for mobile menu -->
    <div class="overlay" id="overlay"></div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1><i class="fas fa-graduation-cap"></i>DMS</h1>
                <p>Director Dashboard</p>
            </div>
            <ul class="nav-links">
                <li><a href="director-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="Director-students.html"><i class="fas fa-users"></i> Students</a></li>
                <li><a href="Director.analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li><a href="Director-report.html"><i class="fas fa-file-alt"></i> Reports</a></li>
                <li><a href="#" class="active"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="register-teacher.html"><i class="fas fa-user-plus"></i> Register Teacher</a></li>

                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h2>System Settings</h2>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">D</div>
                    <div>
                        <div id="user-name">Loading...</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">Director</div>
                    </div>
                </div>
            </div>

            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="tab active" data-tab="term-management">
                    <i class="fas fa-sync-alt"></i> Term Management
                </button>
                <button class="tab" data-tab="student-promotion">
                    <i class="fas fa-graduation-cap"></i> Student Promotion
                </button>
                <button class="tab" data-tab="student-management">
                    <i class="fas fa-user-graduate"></i> Student Management
                </button>
                <button class="tab" data-tab="system-config">
                    <i class="fas fa-sliders-h"></i> System Configuration
                </button>
            </div>

            <!-- Term Management Tab -->
            <div class="tab-content active" id="term-management">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card terms">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="current-term">Term 1</div>
                                <div class="stat-label">Current Term</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card students">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-students">0</div>
                                <div class="stat-label">Total Students</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card promotion">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="next-promotion">-</div>
                                <div class="stat-label">Next Promotion</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card backup">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="last-backup">-</div>
                                <div class="stat-label">Last Backup</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="action-grid">
                    <div class="action-card primary">
                        <div class="action-icon">
                            <i class="fas fa-redo"></i>
                        </div>
                        <h3>Reset Term Conduct</h3>
                        <p>Reset all student conduct scores to 40 points for the new term. Archives current records and starts fresh.</p>
                        <button class="btn btn-primary" id="reset-conduct-btn">
                            <i class="fas fa-play-circle"></i> Start New Term
                        </button>
                    </div>

                    <div class="action-card success">
                        <div class="action-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <h3>Backup System Data</h3>
                        <p>Create a complete backup of all system data including students, conduct records, and term history.</p>
                        <button class="btn btn-success" id="backup-data-btn">
                            <i class="fas fa-save"></i> Create Backup
                        </button>
                    </div>
                </div>

                <!-- Backup Management Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>
                            <div class="section-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            Backup Management
                        </h3>
                        <button class="btn btn-outline btn-sm" id="refresh-backups">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="section-body">
                        <div class="alert-box alert-info">
                            <div class="alert-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="alert-content">
                                <h4>Backup Protection</h4>
                                <p>Regular backups ensure your data is safe during term transitions and system changes.</p>
                            </div>
                        </div>

                        <!-- Backup List -->
                        <div class="backup-list" id="backup-list">
                            <div class="loading-text">Loading backups...</div>
                        </div>
                    </div>
                </div>

                <!-- Current Term Settings -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>
                            <div class="section-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            Current Term Configuration
                        </h3>
                        <div class="term-status">
                            <span class="badge badge-success" id="current-term-status">Active</span>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="alert-box alert-info">
                            <div class="alert-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="alert-content">
                                <h4>Term Management</h4>
                                <p>Configure the current academic term settings. Changes here will update the active term displayed throughout the system.</p>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="term-name">Term Name *</label>
                                <input type="text" id="term-name" class="form-control" placeholder="e.g., Term 1, First Semester">
                                <small class="form-text text-muted">Display name for the current term</small>
                            </div>
                            <div class="form-group">
                                <label for="academic-year">Academic Year *</label>
                                <input type="text" id="academic-year" class="form-control" placeholder="e.g., 2024">
                                <small class="form-text text-muted">The academic year this term belongs to</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="term-start">Term Start Date *</label>
                                <input type="date" id="term-start" class="form-control">
                                <small class="form-text text-muted">Official start date of the term</small>
                            </div>
                            <div class="form-group">
                                <label for="term-end">Term End Date *</label>
                                <input type="date" id="term-end" class="form-control">
                                <small class="form-text text-muted">Expected end date of the term</small>
                            </div>
                        </div>
                        
                        <div class="term-actions">
                            <button class="btn btn-primary" id="save-term-settings">
                                <i class="fas fa-save"></i> Save Term Settings
                            </button>
                            <button class="btn btn-outline" id="reset-term-form">
                                <i class="fas fa-undo"></i> Reset Form
                            </button>
                        </div>
                        
                        <div class="current-term-info" id="current-term-info" style="display: none;">
                            <hr>
                            <h5>Current Term Information</h5>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Term ID:</label>
                                    <span id="info-term-id">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Status:</label>
                                    <span id="info-term-status" class="badge badge-success">Active</span>
                                </div>
                                <div class="info-item">
                                    <label>Created:</label>
                                    <span id="info-term-created">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Promotion Tab -->
            <div class="tab-content" id="student-promotion">
                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Annual Student Promotion</h4>
                        <p>Promote students to the next class at the end of the academic year. Manually select which students should repeat their current class.</p>
                    </div>
                </div>

                <!-- Promotion Stats -->
                <div class="stats-grid">
                    <div class="stat-card terms">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="promotable-students">0</div>
                                <div class="stat-label">Students to Promote</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card students">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="repeat-students">0</div>
                                <div class="stat-label">Selected to Repeat</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-redo"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card promotion">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="graduating-students">0</div>
                                <div class="stat-label">Graduating Students</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-award"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card backup">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="new-classes">0</div>
                                <div class="stat-label">New Classes</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-chalkboard"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Promotion Actions -->
                <div class="action-grid">
                    <div class="action-card primary">
                        <div class="action-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <h3>Promote Students</h3>
                        <p>Move students to the next class level. Manually select which students should repeat.</p>
                        <button class="btn btn-primary" id="promote-students-btn">
                            <i class="fas fa-play"></i> Start Promotion
                        </button>
                    </div>

                    <div class="action-card warning">
                        <div class="action-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3>Review Students</h3>
                        <p>Review all students and their current classes before promotion.</p>
                        <button class="btn btn-warning" id="review-students-btn">
                            <i class="fas fa-search"></i> Review Students
                        </button>
                    </div>
                </div>

                <!-- Repeat Student Selection Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>
                            <div class="section-icon">
                                <i class="fas fa-user-times"></i>
                            </div>
                            Select Students to Repeat
                        </h3>
                        <div class="selected-count">
                            <span id="selected-repeat-count">0</span> selected
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="alert-box alert-warning">
                            <div class="alert-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="alert-content">
                                <h4>Manual Repeat Selection</h4>
                                <p>Select students who should repeat their current class. All other students will be promoted automatically.</p>
                            </div>
                        </div>

                        <!-- Class Filter -->
                        <div class="form-group">
                            <label for="class-filter">Filter by Class</label>
                            <select id="class-filter" class="form-control">
                                <option value="all">All Classes</option>
                                <option value="S1">Senior 1</option>
                                <option value="S2">Senior 2</option>
                                <option value="S3">Senior 3</option>
                                <option value="S4 MSSI">Senior 4 MSSI</option>
                                <option value="S4 MSSII">Senior 4 MSSII</option>
                                <option value="S5 MPC">Senior 5 MPC</option>
                                <option value="S5 MCB">Senior 5 MCB</option>
                                <option value="S5 PCM">Senior 5 PCM</option>
                                <option value="S5 PCB">Senior 5 PCB</option>
                                <option value="S5 MCE">Senior 5 MCE</option>
                                <option value="S6 MPC">Senior 6 MPC</option>
                                <option value="S6 MCB">Senior 6 MCB</option>
                                <option value="S6 PCM">Senior 6 PCM</option>
                                <option value="S6 PCB">Senior 6 PCB</option>
                                <option value="S6 MCE">Senior 6 MCE</option>
                            </select>
                        </div>

                        <!-- Students List for Repeat Selection -->
                        <div class="students-checkbox-list" id="repeat-selection-list">
                            <div class="loading-text">Click "Review Students" to load student list</div>
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <button class="btn btn-outline" id="select-all-btn">
                                <i class="fas fa-check-square"></i> Select All in This Class
                            </button>
                            <button class="btn btn-outline" id="deselect-all-btn">
                                <i class="fas fa-times-circle"></i> Deselect All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Promotion Summary -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>
                            <div class="section-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            Promotion Summary
                        </h3>
                    </div>
                    <div class="section-body">
                        <div class="promotion-summary-grid">
                            <div class="summary-card promote">
                                <div class="summary-value" id="summary-promote-count">0</div>
                                <div class="summary-label">Students to Promote</div>
                            </div>
                            <div class="summary-card repeat">
                                <div class="summary-value" id="summary-repeat-count">0</div>
                                <div class="summary-label">Students to Repeat</div>
                            </div>
                            <div class="summary-card graduate">
                                <div class="summary-value" id="summary-graduate-count">0</div>
                                <div class="summary-label">Graduating Students</div>
                            </div>
                        </div>
                        
                        <div class="alert-box alert-info" style="margin-top: 1rem;">
                            <div class="alert-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="alert-content">
                                <h4>Promotion Rules</h4>
                                <ul style="padding-left: 1.5rem; color: var(--gray); margin: 0;">
                                    <li>All students will be promoted except those manually selected to repeat</li>
                                    <li>Senior 3 and Senior 6 students will graduate automatically</li>
                                    <li>Conduct scores will be reset to 40 for the new academic year</li>
                                    <li>Repeat students maintain their current class</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Management Tab - UPDATED -->
           <div class="tab-content" id="student-management">
    <div class="settings-section">
        <div class="section-header">
            <h3>
                <div class="section-icon">
                    <i class="fas fa-user-times"></i>
                </div>
                Student Expulsion Management
            </h3>
        </div>
        <div class="section-body">
            <div class="alert-box alert-danger">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h4>Student Expulsion</h4>
                    <p>Search for a student and permanently expel them from the system. This action cannot be undone and will remove all student records.</p>
                </div>
            </div>

            <!-- Student Search and Selection -->
            <div class="form-row">
                <div class="form-group">
                    <label for="search-class">Select Class</label>
                    <select id="search-class" class="form-control">
                        <option value="">All Classes</option>
                        <!-- Classes will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="search-student">Search Student</label>
                    <input type="text" id="search-student" class="form-control" placeholder="Enter student name...">
                </div>
            </div>

            <!-- Search Results -->
            <div class="search-results" id="search-results" style="display: none;">
                <h4>Search Results</h4>
                <div class="students-list" id="students-list">
                    <!-- Students will be populated here -->
                </div>
            </div>

            <!-- No Results Message -->
            <div class="empty-state" id="no-results" style="display: none;">
                <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <h4>No Students Found</h4>
                <p>No students match your search criteria.</p>
            </div>

            <!-- Selected Student Info -->
            <div class="selected-student-info" id="selected-student-info" style="display: none;">
                <div class="alert-box alert-warning">
                    <div class="alert-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Selected Student</h4>
                        <div id="student-details">
                            <!-- Student details will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Expulsion Form -->
                <div class="expulsion-form">
                    <h5>Expulsion Details</h5>
                    <div class="form-group">
                        <label for="expel-reason">Reason for Expulsion *</label>
                        <div class="expulsion-reasons">
                            <label class="reason-option">
                                <input type="radio" name="expel-reason" value="disciplinary">
                                <div>Disciplinary Issues</div>
                            </label>
                            <label class="reason-option">
                                <input type="radio" name="expel-reason" value="academic">
                                <div>Academic Failure</div>
                            </label>
                            <label class="reason-option">
                                <input type="radio" name="expel-reason" value="attendance">
                                <div>Poor Attendance</div>
                            </label>
                            <label class="reason-option">
                                <input type="radio" name="expel-reason" value="other">
                                <div>Other Reasons</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expel-details">Additional Details *</label>
                        <textarea id="expel-details" class="form-control" rows="3" placeholder="Provide specific details about the expulsion..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="expel-date">Expulsion Date</label>
                        <input type="date" id="expel-date" class="form-control">
                    </div>

                    <div class="alert-box alert-danger">
                        <div class="alert-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="alert-content">
                            <h4>Final Warning</h4>
                            <p>This action will permanently remove the student from the system. All records including conduct history and faults will be archived.</p>
                        </div>
                    </div>

                    <button class="btn btn-danger" id="confirm-expel-btn" disabled>
                        <i class="fas fa-user-times"></i> Confirm Expulsion
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- System Configuration Tab -->
<div class="tab-content" id="system-config">
    <!-- Admin Credentials Management -->
    <div class="settings-section">
        <div class="section-header">
            <h3>
                <div class="section-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                Admin Credentials Management
            </h3>
        </div>
        <div class="section-body">
            <div class="alert-box alert-warning">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h4>Important Security Notice</h4>
                    <p>Use this section to update administrator login credentials when there are staff changes. These changes will affect system access immediately.</p>
                </div>
            </div>

            <!-- Current Admin Info -->
            <div class="form-group">
                <label for="current-admin-search">Select Administrator to Update</label>
                <select id="current-admin-search" class="form-control">
                    <option value="">-- Select Administrator --</option>
                    <!-- Administrators will be populated dynamically -->
                </select>
            </div>

            <!-- Selected Admin Details -->
            <div id="admin-details" style="display: none;">
                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Selected Administrator</h4>
                        <div id="admin-current-info">
                            <!-- Admin details will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Update Form -->
                <h5>Update Credentials</h5>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-username">New Username *</label>
                        <input type="text" id="new-username" class="form-control" placeholder="Enter new username">
                        <small class="form-text text-muted">This will be the new login username</small>
                    </div>
                    <div class="form-group">
                        <label for="new-email">New Email Address *</label>
                        <input type="email" id="new-email" class="form-control" placeholder="Enter new email address">
                        <small class="form-text text-muted">System notifications will be sent to this email</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" class="form-control" placeholder="Enter new password">
                        <small class="form-text text-muted">Leave blank to keep current password</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password">
                    </div>
                </div>

                <div class="form-group">
                    <label for="update-reason">Reason for Update *</label>
                    <textarea id="update-reason" class="form-control" rows="3" placeholder="Explain why these credentials are being updated (e.g., staff change, security update)..."></textarea>
                    <small class="form-text text-muted">This will be logged for security audit purposes</small>
                </div>

                <div class="alert-box alert-danger">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Security Warning</h4>
                        <p>Changing these credentials will immediately affect the administrator's ability to log in. Ensure the administrator is aware of these changes.</p>
                    </div>
                </div>

                <button class="btn btn-warning" id="update-admin-btn">
                    <i class="fas fa-user-cog"></i> Update Administrator Credentials
                </button>
            </div>
        </div>
    </div>

    <!-- System Maintenance Section -->
    <div class="settings-section">
        <div class="section-header">
            <h3>
                <div class="section-icon">
                    <i class="fas fa-database"></i>
                </div>
                System Maintenance
            </h3>
        </div>
        <div class="section-body">
            <div class="alert-box alert-warning">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-content">
                    <h4>System Maintenance</h4>
                    <p>These actions may affect system performance and should be performed during off-hours.</p>
                </div>
            </div>

            <div class="action-grid">
                <div class="action-card warning">
                    <div class="action-icon">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <h3>Clear Cache</h3>
                    <p>Clear system cache and temporary files to improve performance.</p>
                    <button class="btn btn-warning" id="clear-cache-btn">
                        <i class="fas fa-broom"></i> Clear Cache
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
        </main>
    </div>

    <!-- Reset Conduct Modal -->
    <div class="modal" id="reset-conduct-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Term</h3>
                <button class="modal-close" id="close-reset-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-warning">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Important Notice</h4>
                        <p>This action will reset all student conduct scores to 40 points and archive current term records.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="new-term-name">New Term Name</label>
                    <input type="text" id="new-term-name" class="form-control" placeholder="e.g., Term 2 2024" value="Term 2">
                </div>

                <div class="form-group">
                    <label for="reset-date">Reset Date</label>
                    <input type="date" id="reset-date" class="form-control">
                </div>

                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>What will happen:</h4>
                        <ul style="padding-left: 1.5rem; color: var(--gray); margin: 0;">
                            <li>All student conduct scores reset to 40 points</li>
                            <li>Current term records archived for historical reference</li>
                            <li>New term starts with fresh conduct tracking</li>
                            <li>Previous records remain accessible</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-reset">Cancel</button>
                <button class="btn btn-warning" id="confirm-reset">
                    <i class="fas fa-redo"></i> Confirm Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Backup System Data</h3>
                <button class="modal-close" id="close-backup-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>System Backup</h4>
                        <p>Creating a backup will save all current system data including students, conduct records, and settings.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="backup-name">Backup Name</label>
                    <input type="text" id="backup-name" class="form-control" placeholder="e.g., Pre-Term-2-Backup">
                </div>

                <div class="form-group">
                    <label for="backup-description">Description (Optional)</label>
                    <textarea id="backup-description" class="form-control" rows="3" placeholder="Add any notes about this backup..."></textarea>
                </div>

                <div class="form-group">
                    <label for="backup-type">Backup Type</label>
                    <select id="backup-type" class="form-control">
                        <option value="full">Full System Backup</option>
                        <option value="students">Students Only</option>
                        <option value="conduct">Conduct Data Only</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-backup">Cancel</button>
                <button class="btn btn-success" id="confirm-backup">
                    <i class="fas fa-download"></i> Create Backup
                </button>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div class="modal" id="promotion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Student Promotion</h3>
                <button class="modal-close" id="close-promotion-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-warning">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Annual Promotion</h4>
                        <p>This will promote students to the next class based on your manual selections. Repeat students will remain in their current class.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="promotion-year">Academic Year</label>
                    <input type="text" id="promotion-year" class="form-control" value="2024">
                </div>

                <div class="form-group">
                    <label for="promotion-date-modal">Promotion Date</label>
                    <input type="date" id="promotion-date-modal" class="form-control">
                </div>

                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Promotion Summary</h4>
                        <div id="promotion-summary">
                            <div> <span id="promote-count">0</span> students will be promoted</div>
                            <div> <span id="repeat-count">0</span> students will repeat</div>
                            <div> <span id="graduate-count">0</span> students will graduate</div>
                            <div> Conduct scores will be reset to 40</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="confirm-backup-checkbox" checked>
                        Create automatic backup before promotion
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-promotion">Cancel</button>
                <button class="btn btn-primary" id="confirm-promotion">
                    <i class="fas fa-user-graduate"></i> Confirm Promotion
                </button>
            </div>
        </div>
    </div>

    <!-- Expel Student Modal -->
    <div class="modal" id="expel-student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Expel Student</h3>
                <button class="modal-close" id="close-expel-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-danger">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Warning: Permanent Action</h4>
                        <p>Expelling a student will permanently remove them from the system. This action cannot be undone.</p>
                    </div>
                </div>

                <div id="expel-student-info">
                    <!-- Student info will be populated here -->
                </div>

                <div class="form-group">
                    <label for="expel-reason">Reason for Expulsion *</label>
                    <div class="expulsion-reasons">
                        <label class="reason-option">
                            <input type="radio" name="expel-reason" value="disciplinary">
                            <div>Disciplinary Issues</div>
                        </label>
                        <label class="reason-option">
                            <input type="radio" name="expel-reason" value="academic">
                            <div>Academic Failure</div>
                        </label>
                        <label class="reason-option">
                            <input type="radio" name="expel-reason" value="attendance">
                            <div>Poor Attendance</div>
                        </label>
                        <label class="reason-option">
                            <input type="radio" name="expel-reason" value="other">
                            <div>Other Reasons</div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="expel-details">Additional Details</label>
                    <textarea id="expel-details" class="form-control" rows="3" placeholder="Provide specific details about the expulsion..."></textarea>
                </div>

                <div class="form-group">
                    <label for="expel-date">Expulsion Date</label>
                    <input type="date" id="expel-date" class="form-control">
                </div>

                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>What happens when a student is expelled:</h4>
                        <ul style="padding-left: 1.5rem; color: var(--gray); margin: 0;">
                            <li>Student record is permanently removed from active system</li>
                            <li>All conduct records and faults are archived</li>
                            <li>Student cannot be reinstated</li>
                            <li>Record is moved to expulsion archive for legal compliance</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-expel">Cancel</button>
                <button class="btn btn-danger" id="confirm-expel">
                    <i class="fas fa-user-times"></i> Confirm Expulsion
                </button>
            </div>
        </div>
    </div>

    <!-- Graduate Student Modal -->
    <div class="modal" id="graduate-student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Graduate Student</h3>
                <button class="modal-close" id="close-graduate-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Graduation Processing</h4>
                        <p>Graduated students are automatically moved to alumni records and removed from active lists.</p>
                    </div>
                </div>

                <div id="graduate-student-info">
                    <!-- Student info will be populated here -->
                </div>

                <div class="form-group">
                    <label for="graduation-date">Graduation Date</label>
                    <input type="date" id="graduation-date" class="form-control">
                </div>

                <div class="form-group">
                    <label for="graduation-notes">Graduation Notes (Optional)</label>
                    <textarea id="graduation-notes" class="form-control" rows="3" placeholder="Add any notes about this graduation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-graduate">Cancel</button>
                <button class="btn btn-success" id="confirm-graduate">
                    <i class="fas fa-graduation-cap"></i> Confirm Graduation
                </button>
            </div>
        </div>
    </div>

    <!-- Term History Modal -->
    <div class="modal" id="term-history-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Term History</h3>
                <button class="modal-close" id="close-history-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-box alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Historical Term Records</h4>
                        <p>View all previous academic terms and their statistics.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="history-filter">Filter by Academic Year</label>
                    <select id="history-filter" class="form-control">
                        <option value="all">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>

                <div class="term-history-list" id="term-history-list">
                    <div class="loading-text">Loading term history...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="close-history">Close</button>
            </div>
        </div>
    </div>

<script>
    // Global variables
    let currentUser = null;
    let currentTerm = {};
    let systemStats = {};
    let allStudents = [];
    let selectedRepeatStudents = new Set();
    let currentClassFilter = 'all';
    let selectedStudentForExpulsion = null;

    // Class progression mapping
    const classProgression = {
        'S1': 'S2',
        'S2': 'S3', 
        'S3': 'Graduated',
        'S4 MCE': 'S5 MCE',
        'S4 MSSI': 'S5 MSSI', 
        'S4 MSSII': 'S5 MSSII',
        'S4 PCM': 'S5 PCM',
        'S4 MPC': 'S5 MPC',
        'S4 MCB': 'S5 MCB',
        'S4 PCB': 'S5 PCB',
        'S5 MCE': 'S6 MCE',
        'S5 MSSI': 'S6 MSSI',
        'S5 MSSII': 'S6 MSSII',
        'S5 PCM': 'S6 PCM',
        'S5 MPC': 'S6 MPC',
        'S5 MCB': 'S6 MCB',
        'S5 PCB': 'S6 PCB',
        'S6 MCE': 'Graduated',
        'S6 MSSI': 'Graduated',
        'S6 MSSII': 'Graduated',
        'S6 PCM': 'Graduated',
        'S6 MPC': 'Graduated',
        'S6 MCB': 'Graduated',
        'S6 PCB': 'Graduated'
    };

    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        checkDirectorRole();
        loadSystemData();
        setupEventListeners();
        initializeDates();
        setupMobileMenu();
    });

    // Setup mobile menu functionality
// Setup mobile menu functionality
        function setupMobileMenu() {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (hamburgerMenu && sidebar && overlay) {
                hamburgerMenu.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
                
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
        } // Check if user is authenticated
    function checkAuthentication() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('No token found, redirecting to login');
            window.location.href = '/';
            return;
        }

        try {
            const userData = localStorage.getItem('user');
            if (userData) {
                currentUser = JSON.parse(userData);
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            } else {
                console.log('No user data found');
                logout();
            }
        } catch (error) {
            console.error('Error parsing user data:', error);
            logout();
        }
    }

    // Check if user has director role
    function checkDirectorRole() {
        if (currentUser && currentUser.role !== 'director') {
            showError('Access denied. Director privileges required.');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
    }

    // Setup event listeners
    function setupEventListeners() {

        // Safe event listener helper
        const safeAdd = (id, event, handler) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener(event, handler);
                console.log(` Added ${event} listener to ${id}`);
                return true;
            } else {
                console.warn(` Could not find element: ${id}`);
                return false;
            }
        };

        // Basic navigation
        safeAdd('logout-btn', 'click', logout);
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                switchTab(tabId);
            });
        });
        
        // Term management
        safeAdd('reset-conduct-btn', 'click', showResetModal);
        safeAdd('backup-data-btn', 'click', showBackupModal);
        safeAdd('refresh-backups', 'click', loadBackups);
        
        // Reset modal
        safeAdd('close-reset-modal', 'click', hideResetModal);
        safeAdd('cancel-reset', 'click', hideResetModal);
        safeAdd('confirm-reset', 'click', resetConductScores);
        
        // Backup modal
        safeAdd('close-backup-modal', 'click', hideBackupModal);
        safeAdd('cancel-backup', 'click', hideBackupModal);
        safeAdd('confirm-backup', 'click', createBackup);
        
        // Student promotion
        safeAdd('promote-students-btn', 'click', showPromotionModal);
        safeAdd('review-students-btn', 'click', loadStudentsForPromotion);
        
        // Promotion modal
        safeAdd('close-promotion-modal', 'click', hidePromotionModal);
        safeAdd('cancel-promotion', 'click', hidePromotionModal);
        safeAdd('confirm-promotion', 'click', promoteStudentsWithSelections);
        
        // System maintenance
        safeAdd('clear-cache-btn', 'click', clearCache);

        // Term settings
        safeAdd('save-term-settings', 'click', saveTermSettings);
        safeAdd('reset-term-form', 'click', resetTermForm);

        // Student management
        setupStudentManagementListeners();

        // Admin credentials management
        setupAdminCredentialsListeners();

        // Promotion event listeners
        const classFilter = document.getElementById('class-filter');
        if (classFilter) {
            classFilter.addEventListener('change', function() {
                currentClassFilter = this.value;
                loadStudentsForPromotion();
            });
        }
        
        const selectAllBtn = document.getElementById('select-all-btn');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', selectAllInClass);
        }
        
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        if (deselectAllBtn) {
            deselectAllBtn.addEventListener('click', deselectAll);
        }

        // Load backups when term management tab is opened
        document.querySelector('[data-tab="term-management"]').addEventListener('click', loadBackups);
        
        console.log(' All event listeners setup completed');
    }

    // Setup admin credentials management listeners
    function setupAdminCredentialsListeners() {
        // Safe event listener helper
        const safeAdd = (id, event, handler) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener(event, handler);
                console.log(` Added ${event} listener to ${id}`);
                return true;
            } else {
                console.warn(` Could not find element: ${id}`);
                return false;
            }
        };

        // Admin selection
        safeAdd('current-admin-search', 'change', loadAdminDetails);
        
        // Password validation
        safeAdd('new-password', 'input', validatePassword);
        safeAdd('confirm-new-password', 'input', validatePassword);
        
        // Update button
        safeAdd('update-admin-btn', 'click', updateAdminCredentials);
        
        // Load admins when tab is opened
        document.querySelector('[data-tab="system-config"]').addEventListener('click', loadAllAdmins);
        
        console.log(' Admin credentials listeners setup completed');
    }

    // Setup simplified student management
    function setupStudentManagementListeners() {
        // Class filter
        const searchClass = document.getElementById('search-class');
        if (searchClass) {
            searchClass.addEventListener('change', loadStudentsByClass);
        }
        
        // Student search
        const searchStudent = document.getElementById('search-student');
        if (searchStudent) {
            searchStudent.addEventListener('input', debounce(searchStudents, 500));
        }
        
        // Expulsion form
        const confirmExpelBtn = document.getElementById('confirm-expel-btn');
        if (confirmExpelBtn) {
            confirmExpelBtn.addEventListener('click', confirmStudentExpulsion);
        }
        
        // Expulsion reason selection
        const reasonOptions = document.querySelectorAll('.reason-option');
        if (reasonOptions.length > 0) {
            reasonOptions.forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                    validateExpulsionForm();
                });
            });
        }
        
        // Expulsion details validation
        const expelDetails = document.getElementById('expel-details');
        if (expelDetails) {
            expelDetails.addEventListener('input', validateExpulsionForm);
        }
        
        // Load classes when tab is opened
        document.querySelector('[data-tab="student-management"]').addEventListener('click', loadAvailableClasses);
    }

    // Load available classes
    async function loadAvailableClasses() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/classes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const classes = await response.json();
                const classSelect = document.getElementById('search-class');
                
                classSelect.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(className => {
                    // Only include active classes, exclude Graduated
                    if (className !== 'Graduated') {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    // Load students by class
    async function loadStudentsByClass() {
        const classSelect = document.getElementById('search-class');
        const className = classSelect.value;
        
        if (!className) {
            hideSearchResults();
            return;
        }

        try {
            showLoading('Loading students...');
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/students/class/${encodeURIComponent(className)}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const students = await response.json();
                // Filter out graduated, expelled, and archived students
                const activeStudents = students.filter(student => 
                    student.student_class !== 'Graduated' && 
                    !student.is_expelled &&
                    !student.is_archived
                );
                displayStudentsList(activeStudents);
            } else {
                throw new Error('Failed to load students');
            }
        } catch (error) {
            hideLoading();
            console.error('Error loading students by class:', error);
            showError('Failed to load students: ' + error.message);
        }
    }

    // Search students
    async function searchStudents() {
        const searchTerm = document.getElementById('search-student').value.trim();
        const classFilter = document.getElementById('search-class').value;
        
        if (searchTerm.length < 2) {
            hideSearchResults();
            return;
        }

        try {
            showLoading('Searching students...');
            const token = localStorage.getItem('token');
            
            let url = `/students/search?q=${encodeURIComponent(searchTerm)}`;
            if (classFilter) {
                url += `&class=${encodeURIComponent(classFilter)}`;
            }
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const students = await response.json();
                // Filter out graduated, expelled, and archived students
                const activeStudents = students.filter(student => 
                    student.student_class !== 'Graduated' && 
                    !student.is_expelled &&
                    !student.is_archived
                );
                displayStudentsList(activeStudents);
            } else {
                throw new Error('Search failed');
            }
        } catch (error) {
            hideLoading();
            console.error('Error searching students:', error);
            showError('Search failed: ' + error.message);
        }
    }

    // Display students list
    function displayStudentsList(students) {
        const resultsContainer = document.getElementById('search-results');
        const studentsList = document.getElementById('students-list');
        const noResults = document.getElementById('no-results');
        
        if (students.length === 0) {
            resultsContainer.style.display = 'none';
            noResults.style.display = 'block';
            noResults.innerHTML = `
                <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <h4>No Active Students Found</h4>
                <p>No active students match your search criteria. Graduated, expelled, or archived students are not shown.</p>
            `;
            return;
        }
        
        noResults.style.display = 'none';
        resultsContainer.style.display = 'block';
        
        studentsList.innerHTML = students.map(student => {
            const firstName = student.student_firstName || student.first_name || 'N/A';
            const lastName = student.student_lastName || student.last_name || 'N/A';
            const middleName = student.student_middleName || student.middle_name;
            const studentClass = student.student_class || student.class || 'N/A';
            const conductScore = student.student_conduct || student.conduct_score || 0;
            
            return `
                <div class="student-item" data-student-id="${student.id}">
                    <div class="student-info">
                        <div class="student-name">${firstName} ${lastName}</div>
                        <div class="student-details">
                            ${middleName ? `<span>${middleName}</span>  ` : ''}
                            <span class="student-class">${studentClass}</span>  
                            <span class="conduct-score ${getConductScoreClass(conductScore)}">Conduct: ${conductScore.toFixed(1)}</span>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="selectStudentForExpulsion(${student.id}, '${firstName}', '${lastName}', '${studentClass}', ${conductScore})">
                        <i class="fas fa-user-times"></i> Expel
                    </button>
                </div>
            `;
        }).join('');
        
        hideLoading();
    }

    // Select student for expulsion
    function selectStudentForExpulsion(studentId, firstName, lastName, studentClass, conductScore) {
        selectedStudentForExpulsion = {
            id: studentId,
            firstName: firstName,
            lastName: lastName,
            class: studentClass,
            conductScore: conductScore
        };
        
        // Show selected student info
        const selectedInfo = document.getElementById('selected-student-info');
        const studentDetails = document.getElementById('student-details');
        
        studentDetails.innerHTML = `
            <div><strong>Name:</strong> ${firstName} ${lastName}</div>
            <div><strong>Class:</strong> ${studentClass}</div>
            <div><strong>Current Conduct:</strong> ${conductScore.toFixed(1)}</div>
        `;
        
        selectedInfo.style.display = 'block';
        
        // Set default expulsion date to today
        document.getElementById('expel-date').value = new Date().toISOString().split('T')[0];
        
        // Reset form
        document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('input[name="expel-reason"]').forEach(input => input.checked = false);
        document.getElementById('expel-details').value = '';
        document.getElementById('confirm-expel-btn').disabled = true;
        
        // Scroll to expulsion form
        selectedInfo.scrollIntoView({ behavior: 'smooth' });
    }

    // Validate expulsion form
    function validateExpulsionForm() {
        const reasonSelected = document.querySelector('input[name="expel-reason"]:checked');
        const detailsFilled = document.getElementById('expel-details').value.trim().length > 0;
        const confirmBtn = document.getElementById('confirm-expel-btn');
        
        confirmBtn.disabled = !(reasonSelected && detailsFilled);
    }

    // Confirm student expulsion
    async function confirmStudentExpulsion() {
        if (!selectedStudentForExpulsion) {
            showError('No student selected for expulsion');
            return;
        }

        const reason = document.querySelector('input[name="expel-reason"]:checked');
        const details = document.getElementById('expel-details').value.trim();
        const date = document.getElementById('expel-date').value;

        if (!reason || !details) {
            showError('Please fill all required fields');
            return;
        }

        if (!confirm(`Are you absolutely sure you want to expel ${selectedStudentForExpulsion.firstName} ${selectedStudentForExpulsion.lastName}? This action is PERMANENT and cannot be undone.`)) {
            return;
        }

        try {
            showLoading('Expelling student...');
            const token = localStorage.getItem('token');
            
            const response = await fetch(`/api/director/students/${selectedStudentForExpulsion.id}/expel`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: reason.value,
                    details: details,
                    expulsion_date: date
                })
            });

            if (response.ok) {
                const result = await response.json();
                hideLoading();
                showSuccess(`Student ${selectedStudentForExpulsion.firstName} ${selectedStudentForExpulsion.lastName} has been expelled successfully!`);
                
                // Reset the interface
                resetExpulsionInterface();
                
                // Reload system data to update stats
                loadSystemData();
                
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to expel student');
            }
        } catch (error) {
            hideLoading();
            console.error('Error expelling student:', error);
            showError('Failed to expel student: ' + error.message);
        }
    }

    // Reset expulsion interface
    function resetExpulsionInterface() {
        selectedStudentForExpulsion = null;
        document.getElementById('selected-student-info').style.display = 'none';
        document.getElementById('search-student').value = '';
        document.getElementById('search-class').value = '';
        hideSearchResults();
    }

    // Hide search results
    function hideSearchResults() {
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('no-results').style.display = 'none';
    }

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initialize date fields
    function initializeDates() {
        try {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Format: YYYY-MM-DD
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Set reset modal date
            const resetDateElem = document.getElementById('reset-date');
            if (resetDateElem) resetDateElem.value = todayStr;
            
            // Set promotion modal date
            const promotionDateElem = document.getElementById('promotion-date-modal');
            if (promotionDateElem) promotionDateElem.value = tomorrowStr;
            
            // Set expulsion date
            const expelDateElem = document.getElementById('expel-date');
            if (expelDateElem) expelDateElem.value = todayStr;
            
            // Set graduation date (if exists)
            const graduationDateElem = document.getElementById('graduation-date');
            if (graduationDateElem) graduationDateElem.value = todayStr;
            
            // Fix: Set backup name using JavaScript
            const backupNameElem = document.getElementById('backup-name');
            if (backupNameElem) {
                backupNameElem.value = `Backup-${todayStr}`;
            }
            
            console.log('All dates initialized successfully');
        } catch (error) {
            console.error('Error initializing dates:', error);
        }
    }

    // Switch between tabs
    function switchTab(tabId) {
        // Update active tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
    }

    // Load system data
    async function loadSystemData() {
        try {
            showLoading('Loading system data...');
            const token = localStorage.getItem('token');
            
            // Load system statistics
            const statsResponse = await fetch('/api/director/system-stats', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                systemStats = statsData;
                updateSystemStats(statsData);
                
                // Also load current term settings
                await loadCurrentTermSettings();
                
                hideLoading();
            } else {
                const errorData = await statsResponse.json();
                throw new Error(errorData.error || 'Failed to load system data');
            }
            
        } catch (error) {
            console.error('Error loading system data:', error);
            hideLoading();
            showError('Failed to load system data: ' + error.message);
        }
    }

    // Update system statistics
    function updateSystemStats(stats) {
        document.getElementById('current-term').textContent = stats.current_term || 'Term 1';
        document.getElementById('total-students').textContent = stats.total_students || 0;
        document.getElementById('next-promotion').textContent = stats.next_promotion || 'Not set';
        document.getElementById('last-backup').textContent = stats.last_backup || 'Never';
        
        // Promotion stats
        document.getElementById('promotable-students').textContent = stats.promotable_students || 0;
        document.getElementById('repeat-students').textContent = stats.repeat_students || 0;
        document.getElementById('graduating-students').textContent = stats.graduating_students || 0;
        document.getElementById('new-classes').textContent = stats.new_classes || 0;
    }

    // ===== TERM SETTINGS FUNCTIONS =====

    // Load current term settings
    async function loadCurrentTermSettings() {
        try {
            const token = localStorage.getItem('token');
            
            const response = await fetch('/api/director/current-term', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const termData = await response.json();
                populateTermSettingsForm(termData);
                return termData;
            } else {
                console.error('Failed to load current term settings:', response.status);
                showError('Failed to load term settings. Please try again.');
                return null;
            }
        } catch (error) {
            console.error('Error loading current term settings:', error);
            showError('Error loading term settings: ' + error.message);
            return null;
        }
    }

    // Populate term settings form
    function populateTermSettingsForm(termData) {
        if (!termData) return;

        document.getElementById('term-name').value = termData.name || 'Term 1';
        document.getElementById('academic-year').value = termData.academic_year || new Date().getFullYear().toString();
        
        // Format dates properly for input fields
        if (termData.start_date) {
            const startDate = new Date(termData.start_date);
            document.getElementById('term-start').value = startDate.toISOString().split('T')[0];
        } else {
            document.getElementById('term-start').value = new Date().toISOString().split('T')[0];
        }
        
        if (termData.end_date) {
            const endDate = new Date(termData.end_date);
            document.getElementById('term-end').value = endDate.toISOString().split('T')[0];
        } else {
            // Set default end date (3 months from start)
            const startDate = new Date(termData.start_date || new Date());
            const endDate = new Date(startDate.setMonth(startDate.getMonth() + 3));
            document.getElementById('term-end').value = endDate.toISOString().split('T')[0];
        }
        
        // Update the current term display
        document.getElementById('current-term').textContent = termData.name || 'Term 1';
        
        // Show additional term information if available
        const termInfo = document.getElementById('current-term-info');
        if (termData.id) {
            termInfo.style.display = 'block';
            document.getElementById('info-term-id').textContent = termData.id;
            document.getElementById('info-term-status').textContent = termData.status || 'Active';
            document.getElementById('info-term-created').textContent = termData.created_at ? 
                new Date(termData.created_at).toLocaleDateString() : 'Unknown';
        } else {
            termInfo.style.display = 'none';
        }
    }

    // Save term settings
    async function saveTermSettings() {
        try {
            const token = localStorage.getItem('token');
            const termName = document.getElementById('term-name').value.trim();
            const academicYear = document.getElementById('academic-year').value.trim();
            const termStart = document.getElementById('term-start').value;
            const termEnd = document.getElementById('term-end').value;

            // Validation
            if (!termName) {
                showError('Please enter a term name');
                return;
            }

            if (!termStart) {
                showError('Please select a term start date');
                return;
            }

            if (!termEnd) {
                showError('Please select a term end date');
                return;
            }

            if (new Date(termEnd) <= new Date(termStart)) {
                showError('Term end date must be after term start date');
                return;
            }

            showLoading('Saving term settings...');

            const response = await fetch('/api/director/current-term', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    term_name: termName,
                    academic_year: academicYear,
                    term_start: termStart,
                    term_end: termEnd
                })
            });

            const responseData = await response.json();

            if (response.ok) {
                hideLoading();
                showSuccess('Term settings saved successfully!');
                
                // Update the form with the response data
                populateTermSettingsForm(responseData.term);
                
                // Reload system data to reflect changes everywhere
                loadSystemData();
                
            } else {
                throw new Error(responseData.error || responseData.details || `HTTP ${response.status}: Failed to save term settings`);
            }

        } catch (error) {
            hideLoading();
            console.error('Error saving term settings:', error);
            showError('Failed to save term settings: ' + error.message);
        }
    }

    // Reset term form to current values
    function resetTermForm() {
        loadCurrentTermSettings();
        showSuccess('Form reset to current values');
    }

    // ===== BACKUP MANAGEMENT FUNCTIONS =====

    async function loadBackups() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/director/backups', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayBackups(data.backups);
            } else {
                throw new Error('Failed to load backups');
            }
        } catch (error) {
            console.error('Error loading backups:', error);
            document.getElementById('backup-list').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Failed to load backups: ${error.message}
                </div>
            `;
        }
    }

    function displayBackups(backups) {
        const backupList = document.getElementById('backup-list');
        
        if (!backups || backups.length === 0) {
            backupList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-database" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <h4>No Backups Found</h4>
                    <p>Create your first backup to protect your data.</p>
                </div>
            `;
            return;
        }

        backupList.innerHTML = `
            <div class="backup-grid">
                ${backups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-header">
                            <h4>${backup.name}</h4>
                            <span class="backup-type ${backup.backup_type}">${backup.backup_type}</span>
                        </div>
                        <div class="backup-info">
                            <div class="backup-meta">
                                <div><i class="fas fa-calendar"></i> ${new Date(backup.created_at).toLocaleDateString()}</div>
                                <div><i class="fas fa-user"></i> ${backup.created_by_name}</div>
                            </div>
                            <div class="backup-stats">
                                <div><i class="fas fa-users"></i> ${backup.student_count || 0} students</div>
                                <div><i class="fas fa-exclamation-circle"></i> ${backup.fault_count || 0} faults</div>
                            </div>
                            ${backup.description ? `<div class="backup-description">${backup.description}</div>` : ''}
                        </div>
                        <div class="backup-actions">
                            <button class="btn btn-outline btn-sm" onclick="exportBackup(${backup.id})">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-success btn-sm" onclick="restoreBackup(${backup.id})">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBackup(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async function exportBackup(backupId) {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/director/export-backup/${backupId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${backupId}-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('Backup exported successfully!');
            } else {
                throw new Error('Failed to export backup');
            }
        } catch (error) {
            console.error('Error exporting backup:', error);
            showError('Failed to export backup: ' + error.message);
        }
    }

    async function restoreBackup(backupId) {
        if (!confirm('Are you sure you want to restore this backup? This will overwrite current data.')) {
            return;
        }

        try {
            showLoading('Restoring backup...');
            const token = localStorage.getItem('token');
            const response = await fetch('/api/director/restore-backup', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    backup_id: backupId,
                    restore_type: 'full'
                })
            });

            if (response.ok) {
                const result = await response.json();
                hideLoading();
                showSuccess('Backup restored successfully!');
                loadSystemData();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to restore backup');
            }
        } catch (error) {
            hideLoading();
            console.error('Error restoring backup:', error);
            showError('Failed to restore backup: ' + error.message);
        }
    }

    async function deleteBackup(backupId) {
        if (!confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
            return;
        }

        try {
            showLoading('Deleting backup...');
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/director/backups/${backupId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                hideLoading();
                showSuccess('Backup deleted successfully!');
                loadBackups();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete backup');
            }
        } catch (error) {
            hideLoading();
            console.error('Error deleting backup:', error);
            showError('Failed to delete backup: ' + error.message);
        }
    }

    // ===== TERM RESET FUNCTIONS =====

    function showResetModal() {
        // Set default term name (increment current term)
        const currentTermName = document.getElementById('current-term').textContent;
        const termMatch = currentTermName.match(/Term (\d+)/);
        if (termMatch) {
            const nextTermNum = parseInt(termMatch[1]) + 1;
            document.getElementById('new-term-name').value = `Term ${nextTermNum}`;
        }
        
        document.getElementById('reset-conduct-modal').style.display = 'flex';
    }

    function hideResetModal() {
        document.getElementById('reset-conduct-modal').style.display = 'none';
    }

    async function resetConductScores() {
        try {
            const token = localStorage.getItem('token');
            const termName = document.getElementById('new-term-name').value;
            const resetDate = document.getElementById('reset-date').value;
            
            if (!termName.trim()) {
                showError('Please enter a term name');
                return;
            }
            
            showLoading('Resetting term conduct...');
            
            const response = await fetch('/api/director/reset-conduct', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    term_name: termName,
                    reset_date: resetDate
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                hideLoading();
                showSuccess('Term reset successfully! All student conduct scores have been reset to 40 points.');
                hideResetModal();
                loadSystemData();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to reset conduct scores');
            }
            
        } catch (error) {
            hideLoading();
            console.error('Error resetting conduct:', error);
            showError('Failed to reset conduct scores: ' + error.message);
        }
    }

    // ===== BACKUP FUNCTIONS =====

    function showBackupModal() {
        document.getElementById('backup-modal').style.display = 'flex';
    }

    function hideBackupModal() {
        document.getElementById('backup-modal').style.display = 'none';
    }

    async function createBackup() {
        try {
            const token = localStorage.getItem('token');
            const backupName = document.getElementById('backup-name').value;
            const description = document.getElementById('backup-description').value;
            const backupType = document.getElementById('backup-type').value;
            
            if (!backupName.trim()) {
                showError('Please enter a backup name');
                return;
            }
            
            showLoading('Creating backup...');
            
            const response = await fetch('/api/director/create-backup', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    backup_name: backupName,
                    description: description,
                    backup_type: backupType
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                hideLoading();
                showSuccess('Backup created successfully!');
                hideBackupModal();
                loadSystemData();
                loadBackups();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to create backup');
            }
            
        } catch (error) {
            hideLoading();
            console.error('Error creating backup:', error);
            showError('Failed to create backup: ' + error.message);
        }
    }

    // ===== PROMOTION FUNCTIONS =====

    function viewTermHistory() {
        showSuccess('Term history feature would open here');
    }

    function showPromotionModal() {
        if (allStudents.length === 0) {
            showError('Please load students first by clicking "Review Students"');
            return;
        }

        updatePromotionSummary();
        document.getElementById('promotion-modal').style.display = 'flex';
    }

    function hidePromotionModal() {
        document.getElementById('promotion-modal').style.display = 'none';
    }

    // Load students for promotion management
    async function loadStudentsForPromotion() {
        try {
            showLoading('Loading students for promotion...');
            const token = localStorage.getItem('token');
            
            const response = await fetch('/api/director/students?status=active&limit=1000', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                allStudents = data.students || [];
                displayStudentsForRepeatSelection();
                updatePromotionSummary();
                updatePromotionStats();
                hideLoading();
                showSuccess('Students loaded successfully!');
            } else {
                throw new Error('Failed to load students');
            }
        } catch (error) {
            hideLoading();
            console.error('Error loading students:', error);
            showError('Failed to load students: ' + error.message);
        }
    }

    // Display students for repeat selection
    function displayStudentsForRepeatSelection() {
        const container = document.getElementById('repeat-selection-list');
        const filteredStudents = filterStudentsByClass(allStudents, currentClassFilter);
        
        if (filteredStudents.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                    <div>No students found</div>
                    <small class="text-muted">No students match the current filter</small>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredStudents.map(student => {
            const firstName = student.student_firstName || student.first_name || 'N/A';
            const lastName = student.student_lastName || student.last_name || 'N/A';
            const studentClass = student.student_class || student.class || 'N/A';
            const conductScore = student.student_conduct || student.conduct_score || 0;
            
            return `
                <div class="student-checkbox-item">
                    <input type="checkbox" 
                           id="student-${student.id}" 
                           value="${student.id}"
                           ${selectedRepeatStudents.has(student.id) ? 'checked' : ''}
                           onchange="toggleStudentRepeat(${student.id})">
                    <div class="student-info">
                        <div class="student-name">${firstName} ${lastName}</div>
                        <div class="student-class">${studentClass}  Conduct: ${conductScore.toFixed(1)}</div>
                    </div>
                </div>
            `;
        }).join('');

        updateSelectedCount();
    }

    // Filter students by class
    function filterStudentsByClass(students, classFilter) {
        if (classFilter === 'all') {
            return students.filter(student => {
                const studentClass = student.student_class || student.class || '';
                // Exclude graduated students from promotion selection
                return studentClass !== 'Graduated' && !(student.is_archived || false);
            });
        }
        return students.filter(student => {
            const studentClass = student.student_class || student.class || '';
            return studentClass === classFilter && !(student.is_archived || false);
        });
    }

    // Toggle student repeat selection
    function toggleStudentRepeat(studentId) {
        const checkbox = document.getElementById(`student-${studentId}`);
        if (checkbox.checked) {
            selectedRepeatStudents.add(studentId);
        } else {
            selectedRepeatStudents.delete(studentId);
        }
        updateSelectedCount();
        updatePromotionSummary();
    }

    // Select all students in current class
    function selectAllInClass() {
        const filteredStudents = filterStudentsByClass(allStudents, currentClassFilter);
        filteredStudents.forEach(student => {
            selectedRepeatStudents.add(student.id);
        });
        displayStudentsForRepeatSelection();
        updatePromotionSummary();
    }

    // Deselect all students
    function deselectAll() {
        selectedRepeatStudents.clear();
        displayStudentsForRepeatSelection();
        updatePromotionSummary();
    }

    // Update selected count display
    function updateSelectedCount() {
        const count = selectedRepeatStudents.size;
        document.getElementById('selected-repeat-count').textContent = count;
        document.getElementById('repeat-students').textContent = count;
    }

    // Update promotion summary
    function updatePromotionSummary() {
        const totalStudents = allStudents.filter(student => {
            const studentClass = student.student_class || student.class || '';
            return studentClass !== 'Graduated' && !(student.is_archived || false);
        }).length;
        
        const repeatCount = selectedRepeatStudents.size;
        const promoteCount = totalStudents - repeatCount;
        
        // Count graduating students (S3 and S6 classes)
        const graduateCount = allStudents.filter(student => {
            const studentClass = student.student_class || student.class || '';
            return (studentClass === 'S3' || studentClass.startsWith('S6')) && !(student.is_archived || false);
        }).length;

        document.getElementById('summary-promote-count').textContent = promoteCount;
        document.getElementById('summary-repeat-count').textContent = repeatCount;
        document.getElementById('summary-graduate-count').textContent = graduateCount;
        
        // Update modal summary
        document.getElementById('promote-count').textContent = promoteCount;
        document.getElementById('repeat-count').textContent = repeatCount;
        document.getElementById('graduate-count').textContent = graduateCount;
    }

    // Update promotion stats in the cards
    function updatePromotionStats() {
        const totalStudents = allStudents.filter(student => {
            const studentClass = student.student_class || student.class || '';
            return studentClass !== 'Graduated' && !(student.is_archived || false);
        }).length;
        
        const repeatCount = selectedRepeatStudents.size;
        const promoteCount = totalStudents - repeatCount;
        const graduateCount = allStudents.filter(student => {
            const studentClass = student.student_class || student.class || '';
            return (studentClass === 'S3' || studentClass.startsWith('S6')) && !(student.is_archived || false);
        }).length;

        // Count how many new classes will be created
        const newClasses = calculateNewClasses();

        document.getElementById('promotable-students').textContent = promoteCount;
        document.getElementById('repeat-students').textContent = repeatCount;
        document.getElementById('graduating-students').textContent = graduateCount;
        document.getElementById('new-classes').textContent = newClasses;
    }

    // Calculate how many new classes will be needed
    function calculateNewClasses() {
        const promotedStudents = allStudents.filter(student => 
            !selectedRepeatStudents.has(student.id) && 
            (student.student_class || student.class) !== 'Graduated' && 
            !(student.is_archived || false)
        );
        
        const nextClasses = new Set();
        promotedStudents.forEach(student => {
            const currentClass = student.student_class || student.class || '';
            const nextClass = classProgression[currentClass];
            if (nextClass && nextClass !== 'Graduated') {
                nextClasses.add(nextClass);
            }
        });
        
        return nextClasses.size;
    }

    // Calculate next class for a student
    function calculateNextClass(currentClass) {
        // Direct mapping first
        let nextClass = classProgression[currentClass];
        
        // If no direct match, use pattern matching
        if (!nextClass) {
            if (currentClass.startsWith('S4')) {
                if (currentClass.includes('MSSI') || currentClass.includes('MSS I')) {
                    nextClass = 'S5 MSSI';
                } else if (currentClass.includes('MSSII') || currentClass.includes('MSS II')) {
                    nextClass = 'S5 MSSII';
                } else if (currentClass.includes('MPC')) {
                    nextClass = 'S5 MPC';
                } else if (currentClass.includes('MCB')) {
                    nextClass = 'S5 MCB';
                } else if (currentClass.includes('PCM')) {
                    nextClass = 'S5 PCM';
                } else if (currentClass.includes('PCB')) {
                    nextClass = 'S5 PCB';
                } else if (currentClass.includes('MCE')) {
                    nextClass = 'S5 MCE';
                } else {
                    nextClass = 'S5'; // Generic S5
                }
            } else if (currentClass.startsWith('S5')) {
                if (currentClass.includes('MSSI') || currentClass.includes('MSS I')) {
                    nextClass = 'S6 MSSI';
                } else if (currentClass.includes('MSSII') || currentClass.includes('MSS II')) {
                    nextClass = 'S6 MSSII';
                } else if (currentClass.includes('MPC')) {
                    nextClass = 'S6 MPC';
                } else if (currentClass.includes('MCB')) {
                    nextClass = 'S6 MCB';
                } else if (currentClass.includes('PCM')) {
                    nextClass = 'S6 PCM';
                } else if (currentClass.includes('PCB')) {
                    nextClass = 'S6 PCB';
                } else if (currentClass.includes('MCE')) {
                    nextClass = 'S6 MCE';
                } else {
                    nextClass = 'S6'; // Generic S6
                }
            } else if (currentClass === 'S3' || currentClass.startsWith('S6')) {
                nextClass = 'Graduated';
            } else if (currentClass === 'S1') {
                nextClass = 'S2';
            } else if (currentClass === 'S2') {
                nextClass = 'S3';
            } else {
                nextClass = currentClass; // No change if unknown class
            }
        }
        
        return nextClass;
    }

    // Prepare promotion data
    async function preparePromotionData(repeatStudentIds) {
        const promotionMap = {};
        
        allStudents.forEach(student => {
            const studentId = student.id;
            const currentClass = student.student_class || student.class || '';
            const shouldRepeat = repeatStudentIds.includes(studentId);
            
            let nextClass = currentClass; // Default to repeating
            
            if (!shouldRepeat) {
                // Calculate next class for promotion
                nextClass = calculateNextClass(currentClass);
            }
            
            promotionMap[studentId] = {
                current_class: currentClass,
                next_class: nextClass,
                should_repeat: shouldRepeat,
                student_name: `${student.student_firstName || student.first_name} ${student.student_lastName || student.last_name}`
            };
        });
        
        return promotionMap;
    }

    // Promote students with selections
    async function promoteStudentsWithSelections() {
        try {
            const token = localStorage.getItem('token');
            const academicYear = document.getElementById('promotion-year').value;
            const promotionDate = document.getElementById('promotion-date-modal').value;
            const createBackup = document.getElementById('confirm-backup-checkbox').checked;

            if (!academicYear.trim()) {
                showError('Please enter an academic year');
                return;
            }

            if (!promotionDate) {
                showError('Please select a promotion date');
                return;
            }

            showLoading('Processing student promotion...');

            const repeatStudentIds = Array.from(selectedRepeatStudents);
            
            // Get the actual promotion data
            const promotionData = await preparePromotionData(repeatStudentIds);
            
            console.log('Sending promotion data to backend:', promotionData);
            
            const response = await fetch('/api/director/promote-students', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    academic_year: academicYear,
                    promotion_date: promotionDate,
                    repeat_student_ids: repeatStudentIds,
                    promotion_data: promotionData,
                    promotion_type: 'manual_selection'
                })
            });

            if (response.ok) {
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showSuccess(`Student promotion completed successfully! ${result.results.promoted} promoted, ${result.results.repeated} repeated, ${result.results.graduated} graduated`);
                } else {
                    showError('Promotion completed but with issues: ' + (result.message || 'Unknown error'));
                }
                
                hidePromotionModal();
                
                // Reset selections
                selectedRepeatStudents.clear();
                currentClassFilter = 'all';
                document.getElementById('class-filter').value = 'all';
                
                // Reload data to see changes
                setTimeout(() => {
                    loadSystemData();
                    loadStudentsForPromotion();
                }, 1000);
                
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to promote students');
            }

        } catch (error) {
            hideLoading();
            console.error('Error promoting students:', error);
            showError('Failed to promote students: ' + error.message);
        }
    }

    // ===== UTILITY FUNCTIONS =====

    // Manage classes
    function manageClasses() {
        showSuccess('Opening class management... This would allow configuration of class structure.');
    }

    // Clear cache
    function clearCache() {
        showSuccess('System cache cleared successfully!');
    }

    // Utility function for conduct score styling
    function getConductScoreClass(score) {
        if (score >= 35) return 'text-success';
        if (score >= 25) return 'text-warning';
        return 'text-danger';
    }

    // ===== ADMIN CREDENTIALS MANAGEMENT FUNCTIONS =====

    let selectedAdminForUpdate = null;

    // Load all administrators
    async function loadAllAdmins() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/director/admins', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const admins = await response.json();
                const adminSelect = document.getElementById('current-admin-search');
                
                adminSelect.innerHTML = '<option value="">-- Select Administrator --</option>';
                admins.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.id;
                    option.textContent = `${admin.username} (${admin.role}) - ${admin.email || 'No email'}`;
                    adminSelect.appendChild(option);
                });
            } else {
                throw new Error('Failed to load administrators');
            }
        } catch (error) {
            console.error('Error loading administrators:', error);
            showError('Failed to load administrators: ' + error.message);
        }
    }

    // Load admin details when selected
    async function loadAdminDetails() {
        const adminId = document.getElementById('current-admin-search').value;
        
        if (!adminId) {
            document.getElementById('admin-details').style.display = 'none';
            selectedAdminForUpdate = null;
            return;
        }

        try {
            showLoading('Loading admin details...');
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/director/admins/${adminId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const admin = await response.json();
                selectedAdminForUpdate = admin;
                displayAdminDetails(admin);
            } else {
                throw new Error('Failed to load admin details');
            }
        } catch (error) {
            hideLoading();
            console.error('Error loading admin details:', error);
            showError('Failed to load admin details: ' + error.message);
        }
    }

    // Display admin details
    function displayAdminDetails(admin) {
        const adminDetails = document.getElementById('admin-details');
        const adminInfo = document.getElementById('admin-current-info');
        
        adminInfo.innerHTML = `
            <div><strong>Current Username:</strong> ${admin.username}</div>
            <div><strong>Current Email:</strong> ${admin.email || 'Not set'}</div>
            <div><strong>Role:</strong> ${admin.role}</div>
            <div><strong>Last Login:</strong> ${admin.last_login ? new Date(admin.last_login).toLocaleString() : 'Never'}</div>
            <div><strong>Account Created:</strong> ${admin.created_at ? new Date(admin.created_at).toLocaleDateString() : 'Unknown'}</div>
        `;
        
        // Pre-fill form with current values
        document.getElementById('new-username').value = admin.username;
        document.getElementById('new-email').value = admin.email || '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-new-password').value = '';
        document.getElementById('update-reason').value = '';
        
        adminDetails.style.display = 'block';
        hideLoading();
    }

    // Validate password match
    function validatePassword() {
        const password = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const confirmField = document.getElementById('confirm-new-password');
        
        if (password && confirmPassword) {
            if (password !== confirmPassword) {
                confirmField.style.borderColor = '#f72585';
                return false;
            } else {
                confirmField.style.borderColor = '#4cc9f0';
                return true;
            }
        }
        confirmField.style.borderColor = '';
        return true;
    }

    // Update admin credentials
    async function updateAdminCredentials() {
        if (!selectedAdminForUpdate) {
            showError('No administrator selected for update');
            return;
        }

        const newUsername = document.getElementById('new-username').value.trim();
        const newEmail = document.getElementById('new-email').value.trim();
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const updateReason = document.getElementById('update-reason').value.trim();

        // Validation
        if (!newUsername) {
            showError('Please enter a new username');
            return;
        }

        if (!newEmail) {
            showError('Please enter a new email address');
            return;
        }

        if (!updateReason) {
            showError('Please provide a reason for the credential update');
            return;
        }

        if (newPassword && !validatePassword()) {
            showError('Passwords do not match');
            return;
        }

        if (!confirm(`Are you sure you want to update credentials for ${selectedAdminForUpdate.username}? This will immediately affect their login access.`)) {
            return;
        }

        try {
            showLoading('Updating administrator credentials...');
            const token = localStorage.getItem('token');
            
            const updateData = {
                username: newUsername,
                email: newEmail,
                update_reason: updateReason
            };

            // Only include password if provided
            if (newPassword) {
                updateData.password = newPassword;
            }

            const response = await fetch(`/api/director/admins/${selectedAdminForUpdate.id}/credentials`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                const result = await response.json();
                hideLoading();
                showSuccess(`Administrator credentials updated successfully for ${newUsername}!`);
                
                // Reset the form
                resetAdminCredentialsForm();
                
                // Reload the admin list to reflect changes
                loadAllAdmins();
                
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update administrator credentials');
            }
        } catch (error) {
            hideLoading();
            console.error('Error updating admin credentials:', error);
            showError('Failed to update administrator credentials: ' + error.message);
        }
    }

    // Reset admin credentials form
    function resetAdminCredentialsForm() {
        selectedAdminForUpdate = null;
        document.getElementById('admin-details').style.display = 'none';
        document.getElementById('current-admin-search').value = '';
        document.getElementById('new-username').value = '';
        document.getElementById('new-email').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-new-password').value = '';
        document.getElementById('update-reason').value = '';
    }

    // Logout function
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/';
    }

    // Utility functions
    function showLoading(message = 'Loading...') {
        // Remove existing loading indicator
        hideLoading();
        
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 2000;
            font-size: 1.125rem;
        `;
        
        loadingDiv.innerHTML = `
            <div style="text-align: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <div>${message}</div>
            </div>
        `;
        
        document.body.appendChild(loadingDiv);
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    function showError(message) {
        hideLoading();
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f72585;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                <i class="fas fa-exclamation-circle" style="margin-top: 0.125rem;"></i>
                <div style="flex: 1;">
                    <strong>Error</strong>
                    <div style="margin-top: 0.25rem; font-size: 0.875rem;">${message}</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: none; border: none; color: white; cursor: pointer; padding: 0.25rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(errorDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentElement) {
                errorDiv.remove();
            }
        }, 5000);
    }

    function showSuccess(message) {
        hideLoading();
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4cc9f0;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        `;
        successDiv.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                <i class="fas fa-check-circle" style="margin-top: 0.125rem;"></i>
                <div style="flex: 1;">
                    <strong>Success</strong>
                    <div style="margin-top: 0.25rem; font-size: 0.875rem;">${message}</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: none; border: none; color: white; cursor: pointer; padding: 0.25rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(successDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (successDiv.parentElement) {
                successDiv.remove();
            }
        }, 3000);
    }
</script>
</body>
</html>
